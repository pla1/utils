<html>

<head>
  <title>Screensaver</title>
  <link href='https://fonts.googleapis.com/css?family=Ubuntu' rel='stylesheet' type='text/css'>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <script>
    var params = {};
    window.location.search.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(str, key, value) {
      params[key] = value;
    });
    console.log("PARMS: " + JSON.stringify(params));
    var state = params.state;
    var city = params.city;
    var firstTime = true;
    if (!Boolean(state)) {
      state = 'SC';
    }
    if (!Boolean(city)) {
      city = 'Summerville';
    }

    var chartData;
    var chartOptions = {
      width: 500,
      height: 500,
      redFrom: 90,
      redTo: 120,
      yellowFrom: 0,
      yellowTo: 50,
      greenFrom: 51,
      greenTo: 89
    };
    var chart;

    function dateRoutine() {
      var mdate = new moment();
      $('#dateDiv').text(mdate.format('dddd MMMM D, YYYY'));
      $('#timeDiv').text(mdate.format('h:mm a'));
    }

    function weatherRoutine() {
      var urlString = "http://api.wunderground.com/api/c95c41401f0043ad/geolookup/conditions/q/" + state + "/" + city + ".json";
      console.log(urlString);
      jQuery(document).ready(function($) {
        $.ajax({
          url: urlString,
          dataType: "jsonp",
          success: function(parsed_json) {
            var city = parsed_json['location']['city'];
            var state = parsed_json['location']['state'];
            var temp_f = parsed_json['current_observation']['temp_f'];
            var icon_url = parsed_json['current_observation']['icon_url'];
            chartData.setValue(0, 1, temp_f);
            chart.draw(chartData, chartOptions);
          }
        });
      });
    }

    function init() {
      chart = new google.visualization.Gauge(document.getElementById('chartDiv'));
      chartData = google.visualization.arrayToDataTable([
        ['Label', 'Value'],
        ['Temp', 0]
      ]);
      if (window.innerWidth < 800) {
        chartOptions.width=300;
        chartOptions.height=300;
      }
      dateRoutine();
      weatherRoutine();
      var dateTimer = setInterval(dateRoutine, 60000);
      var weatherTimer = setInterval(weatherRoutine, 1800000);
      var moveImageTimer = setInterval(moveImage, 60000);
    }

    function moveImage() {
      console.log("moveImage");
      var windowHeight = window.innerHeight;
      var windowWidth = window.innerWidth;

      var containerDiv = document.getElementById("containerDiv");
      var containerDivHeight = containerDiv.clientHeight;
      var containerDivWidth = containerDiv.clientWidth;

      var availableSpaceVertical = windowHeight - containerDivHeight;
      var availableSpaceHorizontal = windowWidth - containerDivWidth;
      console.log("container height: " + containerDivHeight + " container width: " + containerDivWidth + " window height: " + windowHeight +
        " window width: " + windowWidth + " available space vertical: " + availableSpaceVertical +
        " available space horizontal: " + availableSpaceHorizontal);

      var randomVerticalPosition = Math.round(Math.random() * availableSpaceVertical);
      var randomHorizontalPosition = Math.round(Math.random() * availableSpaceHorizontal);

      containerDiv.style.top = randomVerticalPosition + "px";
      containerDiv.style.left = randomHorizontalPosition + "px";
    }
    google.charts.load('current', {
      'packages': ['gauge']
    });
    google.charts.setOnLoadCallback(init);
  </script>
  <script src="moment.js"></script>
  <script src="jquery-2.2.0.js"></script>
  <style>
    * {
      font-family: 'Ubuntu', sans-serif;
      color: white;
      background-color: black;
      margin: 0;
      padding: 0;
      cursor: none;
    }

    #dateDiv,
    #timeDiv {
      font-size: 60px;
    }

    #timeDiv {
      float: right;
    }

    #containerDiv {
      position: fixed;
    }

    #chartDiv {
      color: black;
      width:300px;
      width:300px;
    }

    @media (min-width: 800px) {
      #dateDiv,
      #timeDiv {
        font-size: 170px;
        text-align: center;
      }
      #chartDiv {
        width:500px;
        width:500px;
      }
    }
  </style>
</head>

<body>
  <div id="containerDiv">
    <div id="dateDiv">&nbsp;</div>
    <div id="timeDiv">&nbsp;</div>
    <div id="chartDiv"></div>
  </div>
</body>

</html>

