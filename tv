#!/bin/bash
#
# Play a HDHomeRun channel. Pass the channel call letters. On the initial run this will ask you 
# for the IP address of the HDHomeRun device. 
#
CURLY="[{}]"
CR="\n"
BRACKETS="[\]\[]"
IP=$(cat ~/.hdhrIpAddress)
if [ -z "$IP" ]
then
  read -p "Key the IP address of the HDHomeRun and press ENTER " IP
  echo "$IP" > ~/.hdhrIpAddress
fi
callSign="$1"
lineup=$(curl --silent "http://$IP/lineup.json")
if [[ "$lineup" != *"GuideNumber"* ]]
then
  rm -f ~/.hdhrIpAddress
  echo "Missing channel lineup. Check the IP address $IP. Also make sure you have the latest firmware on your HDHomeRun device. https://www.silicondust.com/support/downloads/" 
  exit 1
fi
newLineup="${lineup//$CURLY/$CR}"
lineup="${newLineup//$BRACKETS/}"
line=$(echo -e "$lineup" | grep -i "$callSign")
if [ -z "$line" ]
then
  echo "Call sign \"$callSign\" not found."
  exit 1
fi
urlString=$(echo "$line" | cut -d , -f3)
url=$(echo "$urlString" | cut -d \" -f4)
echo -e "\n\nPlaying $url\n\n"
/usr/bin/mplayer "$url"
